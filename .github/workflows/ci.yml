name: ci

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    name: Ruby 3.4 - Run ${{ matrix.run }}
    strategy:
      fail-fast: false
      matrix:
        run: [1, 2, 3, 4, 5]

    steps:
    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

    - name: Set up Ruby
      uses: ruby/setup-ruby@90be1154f987f4dc0fe0dd0feedac9e473aa4ba8 # v1.286.0
      with:
        ruby-version: '3.4'
        bundler-cache: true

    - name: Show Ruby and gem versions
      run: |
        ruby -v
        gem list minitest
        bundle show minitest || true

    - name: Run setup commands
      run: pushd test/fixtures/coffee && npm install && popd

    - name: Run tests (attempt 1) with verbose output
      run: |
        echo "=== Starting test run 1 at $(date) ==="
        echo "PID: $$"
        SCHMOOZE_DEBUG=1 timeout 60 bundle exec rake test TESTOPTS='-v' 2>&1 || echo "Test run 1 completed or timed out"
        echo "=== Finished test run 1 at $(date) ==="

    - name: Run tests (attempt 2) with verbose output
      run: |
        echo "=== Starting test run 2 at $(date) ==="
        SCHMOOZE_DEBUG=1 timeout 60 bundle exec rake test TESTOPTS='-v' 2>&1 || echo "Test run 2 completed or timed out"
        echo "=== Finished test run 2 at $(date) ==="

    - name: Run tests (attempt 3) with verbose output
      run: |
        echo "=== Starting test run 3 at $(date) ==="
        SCHMOOZE_DEBUG=1 timeout 60 bundle exec rake test TESTOPTS='-v' 2>&1 || echo "Test run 3 completed or timed out"
        echo "=== Finished test run 3 at $(date) ==="

    - name: Check for zombie processes
      if: always()
      run: |
        echo "=== Process list ==="
        ps aux | grep -E "(ruby|node)" || true
        echo "=== Done ==="
